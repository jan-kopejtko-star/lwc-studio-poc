<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LWC Studio — Preview POC</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f0f13;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      gap: 16px;
    }
    h1 { font-size: 20px; font-weight: 600; opacity: 0.9; }
    #status { font-size: 13px; opacity: 0.5; font-family: monospace; }
    #preview-container {
      width: 900px;
      min-height: 500px;
      background: #1a1a24;
      border: 1px solid #2a2a3a;
      border-radius: 12px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 12px;
      border-bottom: 1px solid #2a2a3a;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; }
    .dot.red { background: #ff5f57; }
    .dot.yellow { background: #febc2e; }
    .dot.green { background: #28c840; }
    .component-name { margin-left: 8px; font-size: 13px; opacity: 0.5; font-family: monospace; }
    #lwc-host { min-height: 400px; width: 100%; }
  </style>
</head>
<body>
  <h1>⚡ LWC Studio — Preview POC</h1>
  <div id="status">Loading LO2 script...</div>

  <div id="preview-container">
    <div class="toolbar">
      <div class="dot red"></div>
      <div class="dot yellow"></div>
      <div class="dot green"></div>
      <span class="component-name">task-spark-console</span>
    </div>
    <div id="lwc-host"></div>
  </div>

  <script type="text/javascript" async
    src="https://appspark-dev-ed.develop.my.salesforce.com/lightning/lightning.out.latest/index.iife.prod.js">
  </script>

  <script>
    const SESSION_ID = '00DQy00000EYVLaMAP!AQEAQDLM.CwpND2I8siFKsgacLpFKDqIUFDEtizYq44b7frTe7MS7ix2Oh9w8TbNcptzAj_FuO5XQ26yNZZr2Tcmn_9HT561';
    const ORG_DOMAIN = 'https://appspark-dev-ed.develop.my.salesforce.com';
    const statusEl = document.getElementById('status');

    async function getFrontdoorUrl() {
      // Use the LO2-specific singleaccess endpoint
      const resp = await fetch(`${ORG_DOMAIN}/services/oauth2/lightningoutsingleaccess`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Authorization': `Bearer ${SESSION_ID}`
        }
      });
      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(`singleaccess failed: ${resp.status} ${text}`);
      }
      const data = await resp.json();
      console.log('singleaccess response:', data);
      return data.frontdoor_uri || data.frontdoor_url || data.url;
    }

    async function init() {
      try {
        statusEl.textContent = 'Waiting for LO2 script...';

        // Wait for LO2 to define lightning-out-application
        await new Promise((resolve, reject) => {
          const interval = setInterval(() => {
            if (customElements.get('lightning-out-application')) {
              clearInterval(interval);
              resolve();
            }
          }, 100);
          setTimeout(() => {
            clearInterval(interval);
            reject(new Error('Timed out waiting for LO2 script'));
          }, 10000);
        });

        statusEl.textContent = 'Getting frontdoor URL...';
        const frontdoorUrl = await getFrontdoorUrl();
        console.log('frontdoorUrl:', frontdoorUrl);

        if (!frontdoorUrl) {
          throw new Error('No frontdoor URL returned from singleaccess endpoint');
        }

        statusEl.textContent = 'Initializing Lightning Out 2.0...';

        // Build markup programmatically — no pre-existing tags in HTML
        const host = document.getElementById('lwc-host');

        const loApp = document.createElement('lightning-out-application');
        loApp.setAttribute('app-id', '1UsQy0000000GUbKAM');
        loApp.setAttribute('frontdoor-url', frontdoorUrl);
        loApp.setAttribute('components', 'task-spark-console');
        host.appendChild(loApp);

        const component = document.createElement('task-spark-console');
        host.appendChild(component);

        window.addEventListener('lo.application.ready', () => {
          statusEl.textContent = '✅ App session ready!';
        });

        window.addEventListener('lo.component.ready', () => {
          statusEl.textContent = '✅ task-spark-console rendered!';
        });

        window.addEventListener('lo.application.error', (e) => {
          statusEl.textContent = `❌ App error — check console`;
          console.error('lo.application.error', e.detail);
        });

        window.addEventListener('lo.component.error', (e) => {
          statusEl.textContent = `❌ Component error — check console`;
          console.error('lo.component.error', e.detail);
        });

      } catch (err) {
        statusEl.textContent = `❌ ${err.message}`;
        console.error(err);
      }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
